name: Extract, transform, and load
on:
  workflow_dispatch:

jobs:
  etl:
    name: "ETL"
    runs-on: ubuntu-latest
        
    steps:
      - uses: harmon758/postgresql-action@v1
        with:
          postgresql version: '11'
          postgresql db: calaccess_website
          postgresql user: postgres
          postgresql password: postgres
          
      - name: Checkout the repo
        uses: actions/checkout@v2

      - name: Install pipenv
        run: pipx install pipenv

      - uses: actions/setup-python@v3
        with:
          python-version: '3.9'
          cache: 'pipenv'

      - id: pipenv-install
        name: Install Python dependencies
        run: pipenv install --dev --python `which python`
        
      - name: Set Django settings
        run: cp project/settings_actions.py.template project/settings_local.py
        shell: bash

      - name: Migrate database
        run: pipenv run python -W ignore manage.py migrate;
        shell: bash
        env:
          PGPASSWORD: postgres

      - name: Load scraped data
        run: pipenv run python -W ignore manage.py loadcalaccessscrapeddata --verbosity=3;
        shell: bash
        env:
          PGPASSWORD: postgres

      - name: Update raw and processed data
        run: pipenv run python -W ignore manage.py updatedownloadswebsite --keep-files --noinput --verbosity=3;
        shell: bash
        env:
          PGPASSWORD: postgres
          
      - name: Upload processed files as artifact
        uses: actions/upload-artifact@v3
        with:
          name: processed-data
          path: data/processed
          if-no-files-found: error
          retention-days: 1
